# DMA 读写工具 (dma_tool)

这是一个简单的用户空间命令行工具，用于通过 Xilinx DMA (XDMA) 驱动提供的设备节点进行交互，以实现对指定物理内存地址的读写操作。

## 功能

- **写入数据**: 向指定的物理内存地址写入一段数据 (Host-to-Card)。
- **读取数据**: 从指定的物理内存地址读取一段数据，并保存到文件中 (Card-to-Host)。

## 依赖

- `gcc` 和 `make`
- Xilinx XDMA 内核驱动程序，该驱动会创建以下设备节点：
  - `/dev/xdma0_c2h_0` (用于读取)
  - `/dev/xdma0_h2c_0` (用于写入)
- 本工具通过 `lseek` 系统调用设置目标物理地址，然后使用 `read` 和 `write` 系统调用来触发数据传输。

## 如何构建

进入 `dma_tool` 目录，然后运行 `make` 命令：

```bash
cd dma_tool
make
```

这将会生成一个名为 `dma_tool` 的可执行文件。

## 如何使用

确保您有权限访问 XDMA 设备节点。通常需要 root 权限。

### 读取内存

从指定的物理地址读取数据并存入文件。

**命令格式:**

```bash
sudo ./dma_tool read <物理地址(十六进制)> <长度(字节)> <输出文件名>
```

**示例:**

```bash
# 从物理地址 0x10000000 读取 256 字节并保存到 output.bin 文件中
sudo ./dma_tool read 0x10000000 256 output.bin
```

### 写入内存

向指定的物理地址写入数据。数据必须以十六进制字符串的形式提供。

**命令格式:**

```bash
sudo ./dma_tool write <物理地址(十六进制)> <长度(字节)> <十六进制数据>
```

**注意**: 十六进制数据字符串的长度必须是 `<长度(字节)>` 的两倍。

**示例:**

```bash
# 向物理地址 0x10000000 写入 4 字节数据 (0xDEADBEEF)
sudo ./dma_tool write 0x10000000 4 DEADBEEF
```

## 清理

要删除生成的可执行文件，请运行：

```bash
make clean
```

## 注意事项

- **页面对齐**: 为了保证 DMA 传输的正确性和效率，本工具会自动处理页面对齐。
  - **读取**: 工具会读取包含请求数据的整个页面对齐内存块，然后从中提取所需数据。
  - **写入**: 为防止破坏页面上的相邻数据，工具会执行一个"读-改-写"周期。它会先读取相关的整个页面，修改指定部分，然后将更新后的页面写回。
- 操作物理内存是危险的，不正确的地址或数据可能导致系统崩溃或数据损坏。请谨慎使用。 